<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§çÂè§ÊâìÂ≠óÊú∫ | Retro Typewriter Speed Test</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=Noto+Serif+SC:wght@500;700&display=swap');

        :root {
            --paper-color: #f0e6d2;
            --ink-color: #2b2b2b;
            --accent-gold: #c5a059;
            --error-red: #8b0000;
            --success-green: #006400;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1510;
            font-family: 'Special Elite', 'Noto Serif SC', serif;
            color: var(--paper-color);
            user-select: none;
        }

        /* ÂÖ®Â±ÄÂô™ÁÇπÊª§ÈïúÔºåÂ¢ûÂä†Â§çÂè§ÊÑü */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            z-index: 10;
        }

        /* ÊôïÂΩ±ÊïàÊûú */
        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
            pointer-events: none;
            z-index: 9;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* Â∑¶‰∏äËßíÁæäÁöÆÁ∫∏Âå∫Âüü */
        #parchment-container {
            position: absolute;
            top: 40px;
            left: 40px;
            width: 380px;
            max-width: 80vw;
            z-index: 20;
            transform: rotate(-2deg);
            transition: transform 0.3s ease;
        }

        #parchment-container:hover {
            transform: rotate(0deg) scale(1.02);
        }

        .parchment {
            background-color: var(--paper-color);
            padding: 30px;
            border-radius: 5px;
            box-shadow: 
                0 1px 4px rgba(0,0,0,0.3),
                0 0 40px rgba(0,0,0,0.1) inset;
            position: relative;
            color: var(--ink-color);
            font-size: 1.2rem;
            line-height: 1.6;
        }

        /* ÁæäÁöÆÁ∫∏Á∫πÁêÜÂè†Âä† */
        .parchment::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            pointer-events: none;
            border-radius: 5px;
        }

        /* ÈíâÂ≠êÊïàÊûú */
        .pin {
            position: absolute;
            top: -10px;
            left: 50%;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle at 30% 30%, #c5a059, #5e4b25);
            border-radius: 50%;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transform: translateX(-50%);
            z-index: 21;
        }

        .header-title {
            font-family: 'Noto Serif SC', serif;
            font-weight: 700;
            font-size: 1.4rem;
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(43, 43, 43, 0.2);
            padding-bottom: 10px;
            color: #3e3e3e;
            text-shadow: 0px 1px 0px rgba(255,255,255,0.5);
        }

        #text-display {
            font-family: 'Special Elite', monospace;
            white-space: pre-wrap;
            min-height: 120px;
            position: relative;
        }

        .char {
            position: relative;
            transition: color 0.1s;
        }
        .char.correct { color: var(--success-green); text-shadow: 0 0 1px rgba(0,100,0,0.3); }
        .char.incorrect { color: var(--error-red); text-decoration: line-through; }
        .char.current { 
            background-color: rgba(43, 43, 43, 0.1); 
            box-shadow: 0 0 0 2px rgba(43, 43, 43, 0.1);
            border-radius: 2px;
        }
        
        /* Èó™ÁÉÅÁöÑÂÖâÊ†áÊ®°Êãü */
        .char.current::after {
            content: '|';
            position: absolute;
            right: -6px;
            animation: blink 1s infinite;
            opacity: 0.7;
        }

        @keyframes blink {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* ‰ª™Ë°®ÁõòÂå∫Âüü */
        .stats-panel {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            border-top: 1px dashed rgba(43, 43, 43, 0.3);
            padding-top: 10px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .stat-box span {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 1px;
        }
        .stat-value {
            font-size: 1.2rem;
            color: #000;
        }

        #start-hint {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            color: rgba(240, 230, 210, 0.6);
            font-size: 1rem;
            z-index: 15;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            animation: float 3s ease-in-out infinite;
        }

        #sound-toggle {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 30;
            background: none;
            border: 1px solid rgba(240, 230, 210, 0.3);
            color: rgba(240, 230, 210, 0.6);
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Special Elite', monospace;
            transition: all 0.3s;
            border-radius: 20px;
        }
        
        #sound-toggle:hover {
            background: rgba(240, 230, 210, 0.1);
            color: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ÁßªÂä®Á´ØÊèêÁ§∫ */
        @media (max-width: 768px) {
            #parchment-container {
                width: 90vw;
                left: 5vw;
                top: 20px;
                transform: none;
            }
            #start-hint {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="noise-overlay"></div>
    <div class="vignette"></div>

    <!-- ÁæäÁöÆÁ∫∏ UI -->
    <div id="parchment-container">
        <div class="pin"></div>
        <div class="parchment">
            <div class="header-title">‰ªªÂä°ÁÆÄÊä• #1924</div>
            <div id="text-display">Loading text...</div>
            
            <div class="stats-panel">
                <div class="stat-box">
                    <span>WPM</span>
                    <div class="stat-value" id="wpm">0</div>
                </div>
                <div class="stat-box">
                    <span>Accuracy</span>
                    <div class="stat-value" id="accuracy">100%</div>
                </div>
                <div class="stat-box">
                    <span>Progress</span>
                    <div class="stat-value" id="progress">0/0</div>
                </div>
            </div>
        </div>
    </div>

    <div id="start-hint">ÁÇπÂáªÂ±èÂπïÂºÄÂêØÂ£∞Èü≥Âπ∂ÊâìÂ≠ó (Click to enable sound & type)</div>
    <button id="sound-toggle">üîä AUDIO OFF</button>
    <div id="canvas-container"></div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        /**
         * 0. AUDIO ENGINE (Procedural Sound Synthesis)
         * Generates sounds using Web Audio API to avoid external file loading issues.
         */
        const AudioEngine = {
            ctx: null,
            masterGain: null,
            ambienceNodes: [],
            enabled: false,

            init: function() {
                if (this.ctx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.5;
                this.masterGain.connect(this.ctx.destination);
                this.enabled = true;
                
                // Update UI
                document.getElementById('sound-toggle').innerText = "üîä AUDIO ON";
                
                // Start ambience
                this.playAmbience();
            },

            toggle: function() {
                if (!this.ctx) {
                    this.init();
                } else {
                    if (this.ctx.state === 'suspended') {
                        this.ctx.resume();
                        this.enabled = true;
                        document.getElementById('sound-toggle').innerText = "üîä AUDIO ON";
                    } else {
                        this.ctx.suspend();
                        this.enabled = false;
                        document.getElementById('sound-toggle').innerText = "üîá AUDIO OFF";
                    }
                }
            },

            // Generates a mechanical typewriter click
            playKeyClick: function() {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                
                // 1. The "Thud" (Mechanical impact)
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                // Slight pitch variation for realism
                osc.frequency.setValueAtTime(100 + Math.random() * 40, t); 
                osc.frequency.exponentialRampToValueAtTime(20, t + 0.1);
                
                gain.gain.setValueAtTime(0.8, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                
                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start(t);
                osc.stop(t + 0.1);

                // 2. The "Click" (High frequency snap)
                const noiseBuffer = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.05, this.ctx.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < output.length; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                const noise = this.ctx.createBufferSource();
                noise.buffer = noiseBuffer;
                const noiseFilter = this.ctx.createBiquadFilter();
                noiseFilter.type = 'highpass';
                noiseFilter.frequency.value = 2000;
                const noiseGain = this.ctx.createGain();
                
                noiseGain.gain.setValueAtTime(0.4, t);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(this.masterGain);
                noise.start(t);
            },

            // Generates the "Ding" sound at the end
            playDing: function() {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, t);
                
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.3, t + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
                
                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start(t);
                osc.stop(t + 1.5);
            },

            // Generates the Carriage Return slide sound
            playSlide: function() {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                const duration = 0.5;
                
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * 0.5;
                }
                
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(400, t);
                filter.frequency.linearRampToValueAtTime(800, t + duration);
                
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0.2, t + duration/2);
                gain.gain.linearRampToValueAtTime(0, t + duration);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);
                noise.start(t);
            },

            // Background "Vinyl Crackle" & Room Tone
            playAmbience: function() {
                if (this.ambienceNodes.length > 0) return; // Already playing
                
                // 1. Pink Noise (Room Tone)
                const bufferSize = 2 * this.ctx.sampleRate;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                let b0, b1, b2, b3, b4, b5, b6;
                b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    data[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                    data[i] *= 0.11; 
                    b6 = white * 0.115926;
                }
                
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                noise.loop = true;
                const gain = this.ctx.createGain();
                gain.gain.value = 0.05; // Very low volume room tone
                
                noise.connect(gain);
                gain.connect(this.masterGain);
                noise.start(0);
                this.ambienceNodes.push(noise);

                // 2. Random Crackles (Vinyl dust)
                // We use a script processor or just a loop of pre-calculated clicks
                // For simplicity, we add a low hum here instead to save CPU
                const osc = this.ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = 60; // 60Hz hum
                const humGain = this.ctx.createGain();
                humGain.gain.value = 0.02;
                
                osc.connect(humGain);
                humGain.connect(this.masterGain);
                osc.start(0);
                this.ambienceNodes.push(osc);
            }
        };

        document.getElementById('sound-toggle').addEventListener('click', () => {
            AudioEngine.toggle();
        });
        
        // Resume Audio Context on first click anywhere
        document.body.addEventListener('click', () => {
            if(!AudioEngine.ctx) AudioEngine.init();
        }, { once: true });


        /**
         * 1. 3D SCENE SETUP
         */
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color('#1a1510');
        scene.fog = new THREE.FogExp2('#1a1510', 0.035);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 8, 12);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        const spotLight = new THREE.SpotLight(0xffeeb1, 1.5); // Warm desk lamp light
        spotLight.position.set(5, 15, 5);
        spotLight.angle = Math.PI / 6;
        spotLight.penumbra = 0.5;
        spotLight.decay = 2;
        spotLight.distance = 50;
        spotLight.castShadow = true;
        spotLight.shadow.mapSize.width = 1024;
        spotLight.shadow.mapSize.height = 1024;
        scene.add(spotLight);

        const fillLight = new THREE.PointLight(0xc5a059, 0.5);
        fillLight.position.set(-5, 2, 5);
        scene.add(fillLight);

        /**
         * 2. MATERIALS
         */
        const matBlackMetal = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.4, metalness: 0.6 });
        const matGold = new THREE.MeshStandardMaterial({ color: 0xc5a059, roughness: 0.3, metalness: 0.8 });
        const matKeyBase = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.5, metalness: 0.2 });
        const matKeyTop = new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.9, metalness: 0.1 });
        const matPaper = new THREE.MeshStandardMaterial({ color: 0xfff8e1, roughness: 1.0, metalness: 0.0, side: THREE.DoubleSide });
        const matRoller = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.7, metalness: 0.1 });

        /**
         * 3. TYPEWRITER CONSTRUCTION
         */
        const typewriterGroup = new THREE.Group();
        scene.add(typewriterGroup);

        // Main Body Base
        const bodyGeo = new THREE.BoxGeometry(8, 2, 7);
        const body = new THREE.Mesh(bodyGeo, matBlackMetal);
        body.position.y = 1;
        body.castShadow = true;
        body.receiveShadow = true;
        typewriterGroup.add(body);

        // Upper housing (curved top simulation)
        const topHousingGeo = new THREE.CylinderGeometry(4, 4, 8, 32, 1, false, 0, Math.PI);
        const topHousing = new THREE.Mesh(topHousingGeo, matBlackMetal);
        topHousing.rotation.z = Math.PI / 2;
        topHousing.position.set(0, 2, -1);
        topHousing.castShadow = true;
        typewriterGroup.add(topHousing);

        // Carriage Group (This moves when typing)
        const carriageGroup = new THREE.Group();
        carriageGroup.position.set(0, 3.5, -1.5);
        typewriterGroup.add(carriageGroup);

        // Roller
        const rollerGeo = new THREE.CylinderGeometry(0.8, 0.8, 9, 32);
        const roller = new THREE.Mesh(rollerGeo, matRoller);
        roller.rotation.z = Math.PI / 2;
        roller.castShadow = true;
        carriageGroup.add(roller);

        // Paper in roller (Visual only)
        const paperCurve = new THREE.CurvePath();
        // Simplified paper sheet
        const paperGeo = new THREE.PlaneGeometry(7, 4);
        const paperMesh = new THREE.Mesh(paperGeo, matPaper);
        paperMesh.position.set(0, 2, -0.2);
        paperMesh.rotation.x = -0.2;
        carriageGroup.add(paperMesh);

        // Carriage Knobs
        const knobGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.5, 16);
        const knobL = new THREE.Mesh(knobGeo, matBlackMetal);
        knobL.rotation.z = Math.PI / 2;
        knobL.position.set(-4.7, 0, 0);
        carriageGroup.add(knobL);
        const knobR = knobL.clone();
        knobR.position.set(4.7, 0, 0);
        carriageGroup.add(knobR);


        // Keys Construction
        const keyMeshes = {}; // Map char to mesh
        const keyGroup = new THREE.Group();
        typewriterGroup.add(keyGroup);

        // QWERTY Layout Data
        const keyLayout = [
            { row: 0, keys: "qwertyuiop".split("") },
            { row: 1, keys: "asdfghjkl".split("") },
            { row: 2, keys: "zxcvbnm".split("") }
        ];

        // Create Keys
        keyLayout.forEach((layer, rowIndex) => {
            const rowOffsetZ = 1.5 + (rowIndex * 1.2);
            const yOffset = 1.5 - (rowIndex * 0.5);
            
            const totalKeys = layer.keys.length;
            const rowWidth = totalKeys * 0.9; // spacing
            
            layer.keys.forEach((char, i) => {
                const keyWrapper = new THREE.Group();
                
                // Stem
                const stemGeo = new THREE.CylinderGeometry(0.1, 0.1, 1.5, 8);
                const stem = new THREE.Mesh(stemGeo, matGold);
                stem.position.y = -0.5;
                stem.rotation.x = 0.2; // Angle towards user
                keyWrapper.add(stem);

                // Key Cap Ring
                const ringGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.15, 16);
                const ring = new THREE.Mesh(ringGeo, matGold); // Chrome ring
                ring.position.y = 0.2;
                ring.rotation.x = 0.2;
                keyWrapper.add(ring);

                // Key Cap Inner (Black/White)
                const capGeo = new THREE.CylinderGeometry(0.32, 0.32, 0.16, 16);
                const cap = new THREE.Mesh(capGeo, matKeyTop);
                cap.position.y = 0.22;
                cap.rotation.x = 0.2;
                keyWrapper.add(cap);

                // Positioning
                const xPos = (i * 0.9) - (rowWidth / 2) + 0.45;
                keyWrapper.position.set(xPos, yOffset, rowOffsetZ);
                
                // Add to scene and map
                keyGroup.add(keyWrapper);
                
                // Store reference for animation
                keyMeshes[char] = {
                    mesh: keyWrapper,
                    baseY: yOffset,
                    isPressed: false
                };
            });
        });

        // Spacebar
        const spaceGeo = new THREE.BoxGeometry(4, 0.3, 0.5);
        const spaceMesh = new THREE.Mesh(spaceGeo, matBlackMetal);
        spaceMesh.position.set(0, 0.2, 5);
        spaceMesh.rotation.x = 0.2;
        keyGroup.add(spaceMesh);
        keyMeshes[' '] = { mesh: spaceMesh, baseY: 0.2, isPressed: false };


        // Ground Plane (Desk)
        const deskGeo = new THREE.PlaneGeometry(100, 100);
        const deskMat = new THREE.MeshStandardMaterial({ color: 0x221100, roughness: 0.8 });
        const desk = new THREE.Mesh(deskGeo, deskMat);
        desk.rotation.x = -Math.PI / 2;
        desk.position.y = 0;
        desk.receiveShadow = true;
        scene.add(desk);

        /**
         * 4. ANIMATION & LOGIC
         */
        
        let time = 0;
        let shakeIntensity = 0;

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;

            // Subtle floating of camera for "handheld" feel
            camera.position.x = Math.sin(time * 0.5) * 0.2;
            camera.position.y = 8 + Math.cos(time * 0.3) * 0.1;
            
            // Camera Shake Effect (Exquisite Feel)
            if (shakeIntensity > 0) {
                camera.position.x += (Math.random() - 0.5) * shakeIntensity;
                camera.position.y += (Math.random() - 0.5) * shakeIntensity;
                shakeIntensity *= 0.9; // Dampen shake
            }

            camera.lookAt(0, 2, 0);

            // Subtle Flicker of light on key press
            spotLight.intensity = 1.5 + (Math.random() * shakeIntensity * 2);

            // Key Animations
            for (const k in keyMeshes) {
                const keyData = keyMeshes[k];
                if (keyData.isPressed) {
                    keyData.mesh.position.y = THREE.MathUtils.lerp(keyData.mesh.position.y, keyData.baseY - 0.4, 0.4);
                    if (Math.abs(keyData.mesh.position.y - (keyData.baseY - 0.4)) < 0.05) {
                        keyData.isPressed = false; // Release automatically after hitting bottom
                    }
                } else {
                    keyData.mesh.position.y = THREE.MathUtils.lerp(keyData.mesh.position.y, keyData.baseY, 0.2);
                }
            }

            // Paper shake simulation
            if (shakeIntensity > 0.1) {
                paperMesh.position.y = 2 + (Math.random() * 0.05);
            } else {
                paperMesh.position.y = 2;
            }

            renderer.render(scene, camera);
        }
        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });


        /**
         * 5. GAME LOGIC (TYPEWRITER ENGINE)
         */
        
        const textPhrases = [
            "The quick brown fox jumps over the lazy dog.",
            "To be, or not to be, that is the question.",
            "It was the best of times, it was the worst of times.",
            "All the world's a stage, and all the men and women merely players.",
            "I think, therefore I am.",
            "Elementary, my dear Watson.",
            "In the beginning God created the heaven and the earth.",
            "Call me Ishmael.",
            "Stay hungry, stay foolish.",
            "Life is like a box of chocolates."
        ];

        let currentPhrase = "";
        let charIndex = 0;
        let mistakes = 0;
        let startTime = null;
        let isFinished = false;
        
        const displayEl = document.getElementById('text-display');
        const wpmEl = document.getElementById('wpm');
        const accEl = document.getElementById('accuracy');
        const progEl = document.getElementById('progress');

        function initGame() {
            // Pick random phrase
            currentPhrase = textPhrases[Math.floor(Math.random() * textPhrases.length)];
            charIndex = 0;
            mistakes = 0;
            startTime = null;
            isFinished = false;
            renderText();
            updateStats();
            
            // Reset carriage visual
            carriageGroup.position.x = 2.5; // Start position (right side visually means left side of paper aligned)
        }

        function renderText() {
            displayEl.innerHTML = '';
            currentPhrase.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.innerText = char;
                span.className = 'char';
                if (index === charIndex) span.classList.add('current');
                displayEl.appendChild(span);
            });
        }

        function updateTextVisuals() {
            const chars = displayEl.querySelectorAll('.char');
            chars.forEach((span, index) => {
                span.classList.remove('current', 'correct', 'incorrect');
                if (index === charIndex) span.classList.add('current');
                if (index < charIndex) {
                    span.classList.add('correct');
                }
            });
        }

        function updateStats() {
            if (!startTime) return;
            
            const currentTime = new Date();
            const timeDiffMinutes = (currentTime - startTime) / 60000;
            
            // WPM calculation (Standard: 5 chars = 1 word)
            const wpm = Math.round((charIndex / 5) / timeDiffMinutes) || 0;
            
            const accuracy = Math.floor(((charIndex - mistakes) / charIndex) * 100) || 100;
            
            wpmEl.innerText = wpm;
            accEl.innerText = accuracy + '%';
            progEl.innerText = `${charIndex}/${currentPhrase.length}`;
        }

        function triggerKeyAnimation(key) {
            const lowerKey = key.toLowerCase();
            if (keyMeshes[lowerKey]) {
                keyMeshes[lowerKey].isPressed = true;
                
                // Visual Juice: Shake camera slightly on impact
                shakeIntensity = 0.1;
                
                // Audio Juice: Click sound
                AudioEngine.playKeyClick();

                // Carriage Move Animation (Visual)
                // Move left (-x)
                if(key !== 'Enter') {
                    carriageGroup.position.x -= 0.15; 
                }
            }
        }

        window.addEventListener('keydown', (e) => {
            // Start Audio on first keypress if not started
            if(!AudioEngine.ctx) AudioEngine.init();

            // Prevent default scrolling for Space
            if(e.key === ' ') e.preventDefault();

            // Start timer on first key
            if (!startTime && !isFinished && e.key.length === 1) {
                startTime = new Date();
                document.getElementById('start-hint').style.opacity = '0';
            }

            if (isFinished) {
                if (e.key === 'Enter') initGame();
                return;
            }

            const targetChar = currentPhrase[charIndex];
            
            // Trigger 3D Animation & Sound regardless of correctness
            triggerKeyAnimation(e.key);

            // Logic
            if (e.key === targetChar) {
                // Correct
                const spans = displayEl.querySelectorAll('.char');
                spans[charIndex].classList.add('correct');
                
                charIndex++;
                updateTextVisuals();
                
                if (charIndex >= currentPhrase.length) {
                    finishGame();
                }
            } else if (e.key.length === 1) {
                // Incorrect typing (only count printable chars)
                mistakes++;
                // Optional: Flash red or shake screen
                const spans = displayEl.querySelectorAll('.char');
                if(spans[charIndex]) {
                   spans[charIndex].classList.add('incorrect');
                   // Small shake of parchment
                   const p = document.getElementById('parchment-container');
                   p.style.transform = `rotate(${Math.random()*4 - 2}deg) translateX(5px)`;
                   setTimeout(() => p.style.transform = '', 100);
                   
                   // Audio Feedback for Error (Louder click maybe? Or standard click is fine for now)
                   shakeIntensity = 0.2; // More shake on error
                }
            }
            
            updateStats();
        });

        function finishGame() {
            isFinished = true;
            
            // Audio: DING!
            AudioEngine.playDing();
            AudioEngine.playSlide();

            // Carriage return animation
            const startX = carriageGroup.position.x;
            const duration = 800; // Slower return
            const startTimeAnim = Date.now();

            // Visual Ding
            const ding = document.createElement('div');
            ding.innerText = "* DING *";
            ding.style.position = 'absolute';
            ding.style.top = '50%';
            ding.style.left = '50%';
            ding.style.transform = 'translate(-50%, -50%)';
            ding.style.color = '#c5a059';
            ding.style.fontSize = '4rem';
            ding.style.textShadow = '0 4px 20px rgba(0,0,0,0.8)';
            ding.style.fontFamily = "'Special Elite', serif";
            ding.style.zIndex = 100;
            ding.style.opacity = '0';
            ding.style.transition = 'opacity 0.2s';
            document.body.appendChild(ding);
            
            // Fade in
            setTimeout(() => ding.style.opacity = '1', 50);
            setTimeout(() => {
                ding.style.opacity = '0';
                setTimeout(() => ding.remove(), 500);
            }, 1200);

            function returnCarriage() {
                const now = Date.now();
                const progress = Math.min((now - startTimeAnim) / duration, 1);
                // Ease out cubic
                const ease = 1 - Math.pow(1 - progress, 3);
                
                carriageGroup.position.x = startX + (2.5 - startX) * ease; // Return to 2.5

                if (progress < 1) {
                    requestAnimationFrame(returnCarriage);
                } else {
                    displayEl.innerHTML += '<br><br><span style="color: #c5a059; font-size: 0.9em; border-bottom: 1px solid #c5a059;">[ Êåâ Enter Êç¢Ë°å / Start New Line ]</span>';
                }
            }
            returnCarriage();
        }

        // Initialize
        initGame();

    </script>
</body>
</html>